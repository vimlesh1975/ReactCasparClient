<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/6.0.0-rc.1/fabric.min.js"
		integrity="sha512-P6uimDKoj1nnPSo2sPmgbZy99pPq9nHXhLwddOnLi1DC+fEM83FEUcHPRPifbx1rlRkdMinViaWyDfG45G9BuA=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body style="background-color: grey;">
	<div style="text-align: center;">
		<button onclick="exporthtml()">Export html</button>
		<span title="Put 0 for Infinity">Loop Count:</span><input title="Put 0 for Infinity" id="loopcount"
			type="number" value=0 style="width:40px" />
		<span>Duration:</span><input id="duration" type="number" value=2 style="width:40px" />
		<button onclick="makeAllDefault()">Make All Default</button>
		<button onclick="importHtml()">Import html</button>

	</div>
	<canvas id="canvas" width="1920" height="1080"></canvas>
	<script>
		const makeAllDefault = () => {
			localStorage.clear();
			location.reload();
		}
		const importHtml = () => {
			var fInput = document.createElement("input"); //hidden input to open filedialog
			fInput.setAttribute("type", "file"); //opens files
			fInput.setAttribute("accept", "text/html"); ////only useful for inspector debugging

			fInput.click();
			fInput.onchange = (e) => {
				var file = e.target.files[0];
				var reader = new FileReader();
				reader.onload = function () {
					var text = reader.result;
					const content = text.split("const content =")[1].split("import")[0].split(";")[0];
					// console.log(text)

					canvas.forEachObject((item) => { sheet.detachObject(item.id) });
					// project = core.getProject('HTML Animation Tutorial', { state: { "sheetsById": { "Sheet 1": { "staticOverrides": { "byObject": { "ccg_11": { "scaleY": 1.9696922462872897, "scaleX": 1, "left": 180, "top": 295, "width": 100, "angle": 0 }, "ccg_12": { "left": 155, "top": 227, "width": 200, "angle": 0 }, "ccg_7": { "left": 421.5, "top": 268.46, "width": 897.6, "angle": 0 }, "id_5": { "left": 429.19, "top": 257.46, "width": 935, "angle": 0 } } }, "sequence": { "subUnitsPerUnit": 30, "length": 10, "type": "PositionalSequence", "tracksByObject": { "ccg_12": { "trackData": { "pcB-nYLVky": { "type": "BasicKeyframedTrack", "__debugName": "ccg_12:[\"left\"]", "keyframes": [{ "id": "CxgSlh3ehv", "position": 0, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 268 }, { "id": "ybFtmTm9Pe", "position": 2, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 888 }] } }, "trackIdByPropPath": { "[\"left\"]": "pcB-nYLVky" } }, "ccg_11": { "trackData": { "vPMjR2Hnmw": { "type": "BasicKeyframedTrack", "__debugName": "ccg_11:[\"left\"]", "keyframes": [{ "id": "bP5J8-_5zX", "position": 0, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 180 }, { "id": "MTme81ObYu", "position": 2, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 534 }] } }, "trackIdByPropPath": { "[\"left\"]": "vPMjR2Hnmw" } }, "ccg_7": { "trackData": { "dPI1oQxL9q": { "type": "BasicKeyframedTrack", "__debugName": "ccg_7:[\"left\"]", "keyframes": [{ "id": "sDEK_4wjwx", "position": 0, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": -451.5 }, { "id": "kmeBwpxwuo", "position": 0.367, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 464.3193763885305 }] } }, "trackIdByPropPath": { "[\"left\"]": "dPI1oQxL9q" } }, "id_5": { "trackData": { "lq9QEiI8nt": { "type": "BasicKeyframedTrack", "__debugName": "id_5:[\"left\"]", "keyframes": [{ "id": "jUYmD7W24e", "position": 0, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 1577.19 }, { "id": "M773na6elg", "position": 0.367, "connectedRight": true, "handles": [0.5, 1, 0.5, 0], "type": "bezier", "value": 429.19 }] } }, "trackIdByPropPath": { "[\"left\"]": "lq9QEiI8nt" } } } } } }, "definitionVersion": "0.4.0", "revisionHistory": ["N18oc80TngW7tuYh", "DX1-FiUYbboWX3yW", "LcFf0ItIZXhr3rg_", "ttLI39_lewC6GAh8", "2JZAFyIcCLFbdedu"] } })
					const sheet2 = project.sheet('Sheet 2')

					canvas.loadFromJSON(content, () => {

						canvas.getObjects().forEach(element => {
							var obj = sheet2.object(element.id, {
								left: element.left,
								top: element.top,
								width: element.width,
								height: element.height,
								opacity: core.types.number(element.opacity, { nudgeMultiplier: 0.1 }),
								scaleX: core.types.number(element.scaleX, { nudgeMultiplier: 0.01 }),
								scaleY: core.types.number(element.scaleY, { nudgeMultiplier: 0.01 }),
								angle: element.angle,
								fill: core.types.rgba(hexToRGB(element.fill ? element.fill : '#ff0000')),
								rx: core.types.number(element.rx ? element.rx : 10, { range: [0, 100] }),
								ry: core.types.number(element.ry ? element.rx : 10, { range: [0, 100] }),
								strokeWidth: core.types.number(element.strokeWidth, { range: [0, 100] }),
								stroke: core.types.rgba(element.stroke ? hexToRGB(element.stroke) : hexToRGB('#000000')),
								shadow: { ...shadowOptions, color: core.types.rgba(hexToRGB(element.shadow.color)), blur: core.types.number(parseInt(element.shadow.blur), { range: [0, 100] }) },
								fontSize: core.types.number(element.fontSize ? parseInt(element.fontSize) : 30, { range: [0, 100] }),
								strkdsar: core.types.number(element.strokeDashArray ? parseInt(element.strokeDashArray) : 0, { range: [0, 1000] }),
								strkDsOfst: core.types.number(element.strokeDashOffset ? parseInt(element.strokeDashOffset) : 0, { range: [-1000, 1000] }),
							});

							element.on("mousedown", () => studio.setSelection([obj]), false);
							element.on("mousemove", (e) => onMouseMove(obj, e), false);
							element.on("scaling", (e) => onScaling(obj, e), false);
							element.on("mousedblclick", (e) => onMousedblclick(obj, e), false);

							obj.onValuesChange((obj) => {
								element.set({
									left: obj.left,
									top: obj.top,
									width: obj.width,
									height: obj.height,
									opacity: obj.opacity,
									scaleX: obj.scaleX,
									scaleY: obj.scaleY,
									angle: obj.angle,
									fill: obj.fill,
									rx: obj.rx,
									ry: obj.ry,
									strokeWidth: obj.strokeWidth,
									stroke: obj.stroke,
									shadow: obj.shadow,
									fontSize: obj.fontSize,
									strokeDashArray: [obj.strkdsar, obj.strkdsar],
									strokeDashOffset: obj.strkDsOfst
								});
								element.setCoords();
								canvas.requestRenderAll();
							});
						})
					})

				};
				reader.readAsText(file);
			}

		}
		const exporthtml = () => {
			const aa =
				`<!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Document</title>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/6.0.0-rc.1/fabric.min.js"
                        integrity="sha512-P6uimDKoj1nnPSo2sPmgbZy99pPq9nHXhLwddOnLi1DC+fEM83FEUcHPRPifbx1rlRkdMinViaWyDfG45G9BuA=="
                        crossorigin="anonymous" referrerpolicy="no-referrer"><//script>
        </head>
    
        <body style="overflow:hidden">
        <script>

        const updatestring=(str1, str2) =>{
            const idTemplate =  canvas.getObjects().filter(function(element) {
                return element.id=== str1;
              });
                idTemplate[0].set({text:str2})
                canvas.requestRenderAll();
        }
        const updateimage=(str1, base64data) =>{
            const idTemplate =  canvas.getObjects().filter(function(element) {
                return element.id=== str1;
              });
            //   idTemplate[0].set({preserveAspectRatio: 'none'});
            //   idTemplate[0].setPreserveAspectRatio('none');

              idTemplate[0].setSrc(base64data, function(){
                idTemplate[0].set({preserveAspectRatio: 'none'});
                idTemplate[0].setPreserveAspectRatio('none');
                canvas.requestRenderAll();
              });

        }
        <//script>
            <canvas id="canvas" width="1920" height="1080"></canvas>
            <script type="module">
            const hexToRGB = hex => {
                const red = parseInt(hex.slice(1, 3), 16)
                const green = parseInt(hex.slice(3, 5), 16)
                const blue = parseInt(hex.slice(5, 7), 16)
                return {r:red/255, g:green/255, b:blue/255, a:1} // return an object
                // return [ r, g, b ]
            }
                 const shadowOptions = {
                    color: 'black',
                    blur: 30,
                    offsetX: 0,
                    offsetY: 0,
                    affectStroke: false
                };
                var canvas = new fabric.Canvas('canvas');
                window.canvas=canvas;
                canvas.preserveObjectStacking = true;
                const content ={"version":"5.2.4","objects":[{"type":"ellipse","version":"5.2.4","originX":"left","originY":"top","left":180,"top":330,"width":100,"height":160,"fill":"#0000ff","stroke":"#ffffff","strokeWidth":3,"strokeDashArray":null,"strokeLineCap":"butt","strokeDashOffset":0,"strokeLineJoin":"miter","strokeUniform":true,"strokeMiterLimit":4,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":0.9,"shadow":{"color":"black","blur":30,"offsetX":0,"offsetY":0,"affectStroke":false,"nonScaling":false},"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"rx":50,"ry":80,"id":"ccg_11","class":"class_11","selectable":true},{"type":"circle","version":"5.2.4","originX":"left","originY":"top","left":150,"top":0,"width":200,"height":200,"fill":"#0000ff","stroke":"#ffffff","strokeWidth":3,"strokeDashArray":null,"strokeLineCap":"butt","strokeDashOffset":0,"strokeLineJoin":"miter","strokeUniform":true,"strokeMiterLimit":4,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":{"color":"black","blur":30,"offsetX":0,"offsetY":0,"affectStroke":false,"nonScaling":false},"visible":true,"backgroundColor":"","fillRule":"nonzero","paintFirst":"fill","globalCompositeOperation":"source-over","skewX":0,"skewY":0,"radius":100,"startAngle":0,"endAngle":360,"id":"ccg_12","class":"class_12","selectable":true}]};
                import "https://cdn.jsdelivr.net/npm/@theatre/browser-bundles@0.6.0-dev.4/dist/core-only.min.js"
                const { core } = Theatre
                const project = core.getProject('HTML Animation Tutorial', {state:${JSON.stringify(window.studio.createContentOfSaveFile('HTML Animation Tutorial'))}})
                const sheet = project.sheet('Sheet 1')
                canvas.loadFromJSON(content, ()=> {
                canvas.getObjects().forEach(element => {
           		var obj = sheet.object(element.id, {
                left: element.left,
                top: element.top,
                width: element.width,
                height: element.height,
                opacity: core.types.number(element.opacity, { nudgeMultiplier: 0.1 }),
                scaleX: core.types.number(element.scaleX, { nudgeMultiplier: 0.01 }),
                scaleY: core.types.number(element.scaleY, { nudgeMultiplier: 0.01 }),
                angle: element.angle,
                fill: core.types.rgba(hexToRGB(element.fill?element.fill:'#ff0000')),
                rx: core.types.number(element.rx?element.rx:10, { range: [0, 100] }),
                ry: core.types.number(element.ry?element.rx:10, { range: [0, 100] }),
                strokeWidth: core.types.number(element.strokeWidth, { range: [0, 100] }),
                stroke:core.types.rgba(element.stroke?hexToRGB(element.stroke):hexToRGB('#000000')),
                shadow: { ...shadowOptions, color: core.types.rgba(hexToRGB(element.shadow.color)), blur: core.types.number(parseInt(element.shadow.blur), { range: [0, 100] }) },
                fontSize: core.types.number(element.fontSize?parseInt(element.fontSize):30, { range: [0, 100] }),
                strkdsar: core.types.number(element.strokeDashArray?parseInt(element.strokeDashArray):0, { range: [0, 1000] }),
                strkDsOfst: core.types.number(element.strokeDashOffset?parseInt(element.strokeDashOffset):0, { range: [-1000, 1000] }),
            });
                     obj.onValuesChange((obj) => {
                element.set({
                    left: obj.left,
                    top: obj.top,
                    width: obj.width,
                    height: obj.height,
                    opacity: obj.opacity,
                    scaleX: obj.scaleX,
                    scaleY: obj.scaleY,
                    angle: obj.angle,
                    fill: obj.fill,
                    rx: obj.rx,
                    ry: obj.ry,
                    strokeWidth: obj.strokeWidth,
                    stroke: obj.stroke,
                    shadow: obj.shadow,
                    fontSize: obj.fontSize,
                    strokeDashArray:[obj.strkdsar,obj.strkdsar],
                    strokeDashOffset:obj.strkDsOfst
                });
                element.setCoords();
                canvas.requestRenderAll();
            });
                })
                });
                project.ready.then(() => {
                    sheet.sequence.play({ iterationCount: ${document.getElementById('loopcount').value != 0 ? document.getElementById('loopcount').value : Infinity}, range: [0, ${document.getElementById('duration').value}] })
                })
        <//script>
    </body>
    
    </html>`

			const bb = aa.replaceAll('<//', '</')
			const element = document.createElement("a");
			const file = new Blob([bb], { type: 'text/html' });
			element.href = URL.createObjectURL(file);
			var ss = new Date().toLocaleTimeString('en-US', {
				year: "numeric", month: "numeric", day: "numeric", hour12: false,
				hour: "numeric", minute: "numeric", second: "numeric"
			});
			// var retVal = prompt("Enter file name to save : ", ss + "_FileName");
			var retVal = ss + "_FileName";
			if (retVal !== null) {
				element.download = retVal + '.html';
				document.body.appendChild(element); // Required for this to work in FireFox
				element.click();
			}
		}

		const shadowOptions = {
			color: 'black',
			blur: 30,
			offsetX: 0,
			offsetY: 0,
			affectStroke: false
		};
		var canvas = new fabric.Canvas('canvas');
		canvas.preserveObjectStacking = true;
		const content = { "version": "5.2.4", "objects": [{ "type": "ellipse", "version": "5.2.4", "originX": "left", "originY": "top", "left": 180, "top": 330, "width": 100, "height": 160, "fill": "#0000ff", "stroke": "#ffffff", "strokeWidth": 3, "strokeDashArray": null, "strokeLineCap": "butt", "strokeDashOffset": 0, "strokeLineJoin": "miter", "strokeUniform": true, "strokeMiterLimit": 4, "scaleX": 1, "scaleY": 1, "angle": 0, "flipX": false, "flipY": false, "opacity": 0.9, "shadow": { "color": "black", "blur": 30, "offsetX": 0, "offsetY": 0, "affectStroke": false, "nonScaling": false }, "visible": true, "backgroundColor": "", "fillRule": "nonzero", "paintFirst": "fill", "globalCompositeOperation": "source-over", "skewX": 0, "skewY": 0, "rx": 50, "ry": 80, "id": "ccg_11", "class": "class_11", "selectable": true }, { "type": "circle", "version": "5.2.4", "originX": "left", "originY": "top", "left": 150, "top": 0, "width": 200, "height": 200, "fill": "#0000ff", "stroke": "#ffffff", "strokeWidth": 3, "strokeDashArray": null, "strokeLineCap": "butt", "strokeDashOffset": 0, "strokeLineJoin": "miter", "strokeUniform": true, "strokeMiterLimit": 4, "scaleX": 1, "scaleY": 1, "angle": 0, "flipX": false, "flipY": false, "opacity": 1, "shadow": { "color": "black", "blur": 30, "offsetX": 0, "offsetY": 0, "affectStroke": false, "nonScaling": false }, "visible": true, "backgroundColor": "", "fillRule": "nonzero", "paintFirst": "fill", "globalCompositeOperation": "source-over", "skewX": 0, "skewY": 0, "radius": 100, "startAngle": 0, "endAngle": 360, "id": "ccg_12", "class": "class_12", "selectable": true }] }
		canvas.loadFromJSON(content, canvas.renderAll.bind(canvas), function (o, object) {
			object.set({ shadow: object.shadow ? object.shadow : shadowOptions });
		})
	</script>
	<script type="module">
		import 'https://cdn.jsdelivr.net/npm/@theatre/browser-bundles@0.6.0-dev.4/dist/core-and-studio.js'
		const { core, studio } = Theatre
		window.studio = studio
		window.core = core

		// const extensionConfig = {
		// id: 'hello-world-extension',
		// toolbars: {
		//     global(set, studio) {
		//     set([
		//         {
		//         type: 'Icon',
		//         title: 'HTML Export',
		//         svgSource: 'ðŸ‘',
		//         onClick: () => exporthtml()
		//         },
		//     ])
		//     },
		// },
		// panes: [],
		// }
		// studio.extend(extensionConfig)

		studio.initialize()
		const project = core.getProject('HTML Animation Tutorial', {

		})
		window.project = project;
		const sheet = project.sheet('Sheet 1');
		window.sheet = sheet;
		var mouseDown = 0;
		document.body.onmousedown = function () {
			mouseDown = 1;
		}
		document.body.onmouseup = function () {
			mouseDown = 0;
		}

		const onMouseMove = (obj, event) => {
			if (mouseDown === 1) {
				studio.transaction(({ set }) => {
					set(obj.props.left, event.target.left);
					set(obj.props.top, event.target.top);
					set(obj.props.width, event.target.width);
					set(obj.props.angle, event.target.angle);
				});
			}
		};
		window.onMouseMove = onMouseMove;
		const onScaling = (obj, event) => {
			// console.log(event)
			studio.transaction(({ set }) => {
				set(obj.props.scaleX, event.transform.target.scaleX);
				set(obj.props.scaleY, event.transform.target.scaleY);
			});
		};
		window.onScaling = onScaling;
		const onMousedblclick = (obj, event) => {
			studio.transaction(({ unset }) => {
				unset(obj.props);
			});
		};
		window.onMousedblclick = onMousedblclick;
		const hexToRGB = hex => {
			const red = parseInt(hex.slice(1, 3), 16)
			const green = parseInt(hex.slice(3, 5), 16)
			const blue = parseInt(hex.slice(5, 7), 16)
			return { r: red / 255, g: green / 255, b: blue / 255, a: 1 } // return an object
			// return [ r, g, b ]
		}
		window.hexToRGB = hexToRGB;
		canvas.getObjects().forEach(element => {
			var obj = sheet.object(element.id, {
				left: element.left,
				top: element.top,
				width: element.width,
				height: element.height,
				opacity: core.types.number(element.opacity, { nudgeMultiplier: 0.1 }),
				scaleX: core.types.number(element.scaleX, { nudgeMultiplier: 0.01 }),
				scaleY: core.types.number(element.scaleY, { nudgeMultiplier: 0.01 }),
				angle: element.angle,
				fill: core.types.rgba(hexToRGB(element.fill ? element.fill : '#ff0000')),
				rx: core.types.number(element.rx ? element.rx : 10, { range: [0, 100] }),
				ry: core.types.number(element.ry ? element.rx : 10, { range: [0, 100] }),
				strokeWidth: core.types.number(element.strokeWidth, { range: [0, 100] }),
				stroke: core.types.rgba(element.stroke ? hexToRGB(element.stroke) : hexToRGB('#000000')),
				shadow: { ...shadowOptions, color: core.types.rgba(hexToRGB(element.shadow.color)), blur: core.types.number(parseInt(element.shadow.blur), { range: [0, 100] }) },
				fontSize: core.types.number(element.fontSize ? parseInt(element.fontSize) : 30, { range: [0, 100] }),
				strkdsar: core.types.number(element.strokeDashArray ? parseInt(element.strokeDashArray) : 0, { range: [0, 1000] }),
				strkDsOfst: core.types.number(element.strokeDashOffset ? parseInt(element.strokeDashOffset) : 0, { range: [-1000, 1000] }),
			});

			element.on("mousedown", () => studio.setSelection([obj]), false);
			element.on("mousemove", (e) => onMouseMove(obj, e), false);
			element.on("scaling", (e) => onScaling(obj, e), false);
			element.on("mousedblclick", (e) => onMousedblclick(obj, e), false);

			obj.onValuesChange((obj) => {
				element.set({
					left: obj.left,
					top: obj.top,
					width: obj.width,
					height: obj.height,
					opacity: obj.opacity,
					scaleX: obj.scaleX,
					scaleY: obj.scaleY,
					angle: obj.angle,
					fill: obj.fill,
					rx: obj.rx,
					ry: obj.ry,
					strokeWidth: obj.strokeWidth,
					stroke: obj.stroke,
					shadow: obj.shadow,
					fontSize: obj.fontSize,
					strokeDashArray: [obj.strkdsar, obj.strkdsar],
					strokeDashOffset: obj.strkDsOfst
				});
				element.setCoords();
				canvas.requestRenderAll();
			});

		});
		project.ready.then(() => {
			sheet.sequence.play({ iterationCount: 1, range: [0, 2] })
		})
	</script>
</body>

</html>